import pytest
import torch

import source.nn.metrics as metrics


class TestPretrainMetrics:
    @pytest.mark.parametrize(
        ('logits', 'y', 'expected'),
        (
            (
                torch.tensor(
                    [
                        [
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,8,9]
                    ],
                    dtype=torch.long
                ),
                (torch.tensor(8) / torch.tensor(10)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2],
                        [3,4,5],
                        [6,7,8],
                        [9,21,21]
                    ],
                    dtype=torch.long
                ),
                (torch.tensor(6) / torch.tensor(10)).item()
            )
        )
    )
    def test_pretrain_accuracy(self,logits,y,expected):
        calculated = metrics.pretrain_accuracy(logits, y)
        assert calculated == expected


    @pytest.mark.parametrize(
        ('logits', 'y', 'k', 'expected'),
        (
            (
                torch.tensor(
                    [
                        [
                            [0.1,0.4,0,0,0,0.3,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0],
                            [0,0.4,0.3,0.2,0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0.1,0,0.2,0,0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0.2,0,0.4,0,0.1,0],
                            [0.2,0,0,0.3,0.4,0,0,0,0,0,0,0,0,0,0,0,0,0.1,0,0]
                        ],
                        [
                            [0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0,0.4,0,0,0,0,0],
                            [0,0,0,0,0,0,0.4,0,0,0.3,0,0,0.2,0,0,0.1,0,0,0,0],
                            [0,0,0,0,0.4,0,0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0.2,0,0.1,0,0,0],
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,8,9]
                    ],
                    dtype=torch.long
                ),
                3,
                (torch.tensor(8) / torch.tensor(10)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0.1,0.4,0,0,0,0.3,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0],
                            [0,0.4,0.3,0.2,0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0.1,0,0.2,0,0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0.2,0,0.4,0,0.1,0],
                            [0.2,0,0,0.3,0.4,0,0,0,0,0,0,0,0,0,0,0,0,0.1,0,0],
                            [0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0,0.4,0,0,0,0,0]
                        ],
                        [
                            [0,0,0.4,0,0,0,0,0,0,0.3,0,0,0.2,0,0,0.1,0,0,0,0],
                            [0,0,0,0,0.4,0,0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.1,0,0,0,0,0,0.2,0,0,0,0.4,0]
                        ],
                        [
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0.2,0,0.1,0,0,0],
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2],
                        [3,4,5],
                        [6,7,8],
                        [9,21,21]
                    ],
                    dtype=torch.long
                ),
                3,
                (torch.tensor(6) / torch.tensor(10)).item()
            )
        )
    )
    def test_pretrain_topk_accuracy(self,logits,y,k,expected):
        calculated = metrics.pretrain_topk_accuracy(logits, y, k)
        assert calculated == expected


    @pytest.mark.parametrize(
        ('logits', 'x', 'y', 'third', 'expected'),
        (
            (
                torch.tensor(
                    [
                        [
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                0,
                (torch.tensor(2) / torch.tensor(3)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                1,
                (torch.tensor(2) / torch.tensor(2)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                2,
                (torch.tensor(1) / torch.tensor(2)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                        ],
                        [
                            [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0],
                            [0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,21,21],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                2,
                None
            )
        )
    )
    def test_pretrain_accuracy_third(self,logits,x,y,third,expected):
        calculated = metrics.pretrain_accuracy_third(logits, x, y, third)
        assert calculated == expected


    @pytest.mark.parametrize(
        ('logits', 'x', 'y', 'k', 'third', 'expected'),
        (
            (
                torch.tensor(
                    [
                        [
                            [0.1,0.4,0,0,0,0.3,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0],
                            [0,0.4,0.3,0.2,0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0.1,0,0.2,0,0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0.2,0,0.4,0,0.1,0],
                            [0.2,0,0,0.4,0,0,0,0.3,0,0,0,0,0,0,0,0,0,0.1,0,0]
                        ],
                        [
                            [0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0,0.4,0,0,0,0,0],
                            [0,0,0,0,0,0,0.4,0,0,0.3,0,0,0.2,0,0,0.1,0,0,0,0],
                            [0,0,0,0,0.4,0,0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0.2,0,0.1,0,0,0],
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                3,
                0,
                (torch.tensor(2) / torch.tensor(3)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0.1,0.4,0,0,0,0.3,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0],
                            [0,0.4,0.3,0.2,0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0.1,0,0.2,0,0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0.2,0,0.4,0,0.1,0],
                            [0.2,0,0,0.4,0,0,0,0.3,0,0,0,0,0,0,0,0,0,0.1,0,0]
                        ],
                        [
                            [0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0,0.4,0,0,0,0,0],
                            [0,0,0,0,0,0,0.4,0,0,0.3,0,0,0.2,0,0,0.1,0,0,0,0],
                            [0,0,0,0,0.4,0,0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0.2,0,0.1,0,0,0],
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                3,
                1,
                (torch.tensor(2) / torch.tensor(2)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0.1,0.4,0,0,0,0.3,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0],
                            [0,0.4,0.3,0.2,0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0.1,0,0.2,0,0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0.2,0,0.4,0,0.1,0],
                            [0.2,0,0,0.4,0,0,0,0.3,0,0,0,0,0,0,0,0,0,0.1,0,0]
                        ],
                        [
                            [0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0,0.4,0,0,0,0,0],
                            [0,0,0,0,0,0,0.4,0,0,0.3,0,0,0.2,0,0,0.1,0,0,0,0],
                            [0,0,0,0,0.4,0,0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0.2,0,0.1,0,0,0],
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                3,
                2,
                (torch.tensor(1) / torch.tensor(2)).item()
            ),
            (
                torch.tensor(
                    [
                        [
                            [0.1,0.4,0,0,0,0.3,0,0,0,0.2,0,0,0,0,0,0,0,0,0,0],
                            [0,0.4,0.3,0.2,0.1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                            [0.1,0,0.2,0,0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0,0,0,0,0,0,0.2,0,0.4,0,0.1,0],
                            [0.2,0,0,0.4,0,0,0,0.3,0,0,0,0,0,0,0,0,0,0.1,0,0]
                        ],
                        [
                            [0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0,0.4,0,0,0,0,0],
                            [0,0,0,0,0,0,0.4,0,0,0.3,0,0,0.2,0,0,0.1,0,0,0,0],
                            [0,0,0,0,0.4,0,0,0.3,0,0,0,0.2,0,0,0,0.1,0,0,0,0],
                            [0,0,0,0.3,0,0,0,0,0.4,0,0,0,0,0,0.2,0,0.1,0,0,0],
                            [0,0,0,0,0.4,0,0.3,0,0,0,0,0.2,0,0.1,0,0,0,0,0,0]
                        ]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [
                        [0,1,2,3,4],
                        [5,6,7,21,21]
                    ]
                ),
                torch.tensor(
                    [
                        [0,1,2,21,21],
                        [5,6,21,21,21]
                    ],
                    dtype=torch.long
                ),
                3,
                2,
                None
            )
        )
    )
    def test_pretrain_topk_accuracy_third(self,logits,x,y,k,third,expected):
        calculated = metrics.pretrain_topk_accuracy_third(logits, x, y, k, third)
        assert calculated == expected


class TestFinetuneMetrics:
    @pytest.mark.parametrize(
        ('x', 'y', 'expected'),
        (
            (
                torch.tensor(
                    [
                        [1,0],
                        [1,0],
                        [1,0],
                        [0,1],
                        [0,1]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [0,0,0,0,1],
                    dtype=torch.long
                ),
                (torch.tensor(4) / torch.tensor(5)).item()
            ),
            (
                torch.tensor(
                    [
                        [1,0],
                        [1,0],
                        [1,0],
                        [0,1],
                        [0,1]
                    ],
                    dtype=torch.float
                ),
                torch.tensor(
                    [1,1,0,0,0],
                    dtype=torch.long
                ),
                (torch.tensor(1) / torch.tensor(5)).item()
            )
        )
    )
    def test_finetune_accuracy(self,x,y,expected):
        calculated = metrics.finetune_accuracy(x, y)
        assert calculated == expected